(()=>{"use strict";class e{static DEFAULT={interval:30,chime:!1,notify:!1,smartIfSimple:!1,new_version:!1,username:"",password:"",volume:50,course_list:[],watchSlack:!1,darkmode:!1,diff:!0,diffFromGit:!1,curriculumSubMenu:!1,curriculums:[]};props=e.DEFAULT;async getSettings(){this.props=await chrome.storage.local.get(e.DEFAULT)}async setSettings(){await chrome.storage.local.set(this.props)}get interval(){return this.props.interval}get chime(){return this.props.chime}get notify(){return this.props.notify}get smartIfSimple(){return this.props.smartIfSimple}get new_version(){return this.props.new_version}get username(){return this.props.username}get password(){return this.props.password}get volume(){return this.props.volume}get course_list(){return this.props.course_list}get watchSlack(){return this.props.watchSlack}get darkmode(){return this.props.darkmode}get diff(){return this.props.diff}get diffFromGit(){return this.props.diffFromGit}get curriculumSubMenu(){return this.props.curriculumSubMenu}get curriculums(){return this.props.curriculums}set interval(e){this.props.interval=e}set chime(e){this.props.chime=e}set notify(e){this.props.notify=e}set smartIfSimple(e){this.props.smartIfSimple=e}set new_version(e){this.props.new_version=e}set username(e){this.props.username=e}set password(e){this.props.password=e}set volume(e){this.props.volume=e}set course_list(e){this.props.course_list=e}set watchSlack(e){this.props.watchSlack=e}set darkmode(e){this.props.darkmode=e}set diff(e){this.props.diff=e}set diffFromGit(e){this.props.diffFromGit=e}set curriculumSubMenu(e){this.props.curriculumSubMenu=e}set curriculums(e){this.props.curriculums=e}}class t{_element;constructor(e){this._element=this.initialize(e)}initialize(e){return"string"==typeof e?document.createElement(e):"object"==typeof e?e:document.createElement("s")}static create(e){return new t(e)}addClass(e){return"string"==typeof e&&""!==e?this._element.classList.add(e):e&&"Array"===e.constructor.name&&e.forEach((e=>this.addClass(e)),this),this}removeClass(e){return this._element.classList.remove(e),this}addEventListener(e,t){return this._element.addEventListener(e,t),this}prop(e,t){if("object"==typeof e)this._setObjectProp(this._element,e);else{const r=this._element;if(void 0===t)return e in r?String(r[e]):"";e in r&&(r[e]=t)}return this}_setObjectProp(e,t){Object.keys(t).forEach((r=>{const s=t[r];"object"==typeof s?this._setObjectProp(e[r],s):e[r]=s}),this)}get(){return this._element}set(e){return this._element=this.initialize(e),this}appendChild(e){return this._element.append(e instanceof t?e.get():e),this}insertFirst(e){return this._element.insertBefore(e instanceof t?e.get():e,this._element.firstChild),this}text(e){return void 0===e?this._element.innerText:(this._element.innerText=e,this)}style(e){return Object.keys(e).forEach((t=>{console.log(t,e[t]),this._element.style.setProperty(t,e[t])}),this),this}}class r{#e=document.body;queryId(e){return r.queryId(e)}static queryId(e){const t=document.getElementById(e);if(null===t)throw new Error(`要素が取得できませんでした。ID:${e}`);return t}static queryAll(e){return document.querySelectorAll(e)}queryAll(e){return this.#e.querySelectorAll(e)}static query(e,t){return r._query(null,e,t??!1)}query(e,t){return r._query(this.#e,e,t??!1)}static _query(e,t,r){const s=(e??document).querySelector(t);if(null===s){if(void 0===r||void 0!==r&&!r)throw new Error(`要素が取得できませんでした。Selector:${t}`);return null}return s}get_document(){return this.#e}set_document(e){return this.#e=e,this}static notify(e,t){chrome.runtime.sendMessage({type:"notification",title:e,body:t})}}const s=new r,n=new e;let i=30,o=!1,a=!1,c=!1,l=!1;const p=chrome,d=new Audio(p.runtime.getURL("resources/chime.mp3"));d.volume=.5;let u=0,h="9999/99/99 99:99:99";const m=document.title,f=()=>t.create("li").addClass("sidemenu-li").addClass("mentorChangeEx"),g=(e,r)=>f().appendChild(t.create("div").addClass("pluginSwitchArea").appendChild(t.create("input").prop({id:"pluginSwitchButton"+e,type:"checkbox"})).appendChild(t.create("label").prop({htmlFor:"pluginSwitchButton"+e}).appendChild(t.create("span"))).appendChild(t.create("div").addClass("swImg"))).appendChild(t.create("span").prop({style:{color:"white"}}).text(r)),y=()=>{const e=new Date;return("0"+e.getHours()).slice(-2)+":"+("0"+e.getMinutes()).slice(-2)+":"+("0"+e.getSeconds()).slice(-2)},w=e=>{const s=r.queryAll(".container-fluid .row .col-lg-12 table tr td:first-of-type a");t.create(r.query("ol.breadcrumb")).style({display:e?"none":""}),t.create(r.query("ul.nav-tabs")).style({display:e?"none":""}),t.create(r.query("#page-content-wrapper h2")).style({padding:e?"0":""}),s.forEach((r=>{const s=t.create(r),n=s.prop("href");if(s.prop("target","_blank"),e&&c)s.prop({dataset:{method:"post"},href:n+"/start_review"}).text("開始");else if(n.indexOf("/start_review")>0){const e=n.replace("/start_review","");s.prop({dataset:{method:""},href:e}).text("詳細")}})),[4,6,7,9].forEach((t=>{r.queryAll("table tr th:nth-of-type("+t+"),table tr td:nth-of-type("+t+")").forEach((t=>{t.style.display=e?"none":""}))}))},b=()=>{const e=r.query(".navbar.navbar-fixed-top").style;return e.backgroundColor=e.backgroundColor?"":"#cb3333",e.borderColor=e.borderColor?"":"#cb3333",new Promise((e=>{setTimeout((()=>{e("timeout")}),500)}))},v=async()=>{r.queryId("pluginSwitchButton1").checked&&fetch(location.href,{method:"GET",mode:"same-origin",credentials:"include"}).then((e=>{if(!e.ok)throw new Error("HTTP error! status: "+e.status);return e.text()})).then((e=>{const t=document.implementation.createHTMLDocument("").documentElement;t.innerHTML=e;const n="#page-content-wrapper",i=s.set_document(t).query(n);r.query(n).outerHTML=i.outerHTML;let o="";s.queryAll("#page-content-wrapper table tr td:nth-of-type(8)").forEach((e=>{o=o<e.innerText?e.innerText:o})),w(r.queryId("pluginSwitchButton2").checked),!h&&o||h&&o&&h<o?(r.queryId("pluginSwitchButton4").checked&&d.play(),r.queryId("pluginSwitchButton5").checked&&(r.notify("課題レビュー","更新があります。"),document.title="!!変更あり!! "+m,(async()=>{for(let e=0;e<6;e++)await b()})()),console.info("A change has been detected. "+y())):document.title="監視中... "+m,h=o,r.queryId("pluginSwitchMessage").innerText="更新："+y()})).catch((e=>{throw e}))};(async()=>{await n.getSettings(),i=n.interval<=30?30:n.interval,o=n.chime,a=n.notify,c=n.smartIfSimple,l=n.new_version,d.volume=.01*n.volume,await(async()=>{t.create(r.query("#sidebar-wrapper ul:last-child")).addClass("u-border");const e=t.create("ul").addClass("sidebar-nav-mentor");if(t.create(r.query("#sidebar-wrapper")).appendChild(e),e.appendChild(t.create("h5").text("Plugin").addClass(["font-size-x-small","add-margin-0","add-padding-10","font-color-gray-lighter"])),n.watchSlack&&e.appendChild(f().appendChild(t.create("a").prop({href:"/mentor/all/reports?custom=1",target:"_blank"}).addClass(["side-link","sidebar-icon"]).appendChild(t.create("i").addClass(["fa","fa-external-link","font-color-white","add-padding-right-15"]).appendChild(t.create("span").addClass(["add-padding-left-15","display-inline-block"]).text("Slack通知用ページ"))))),"/mentor/all/reports"==location.pathname){const t=g(2,"　シンプル化");t.addEventListener("change",(e=>{w(e.target.checked)})),e.appendChild(t)}const s=g(4,"　チャイム");e.appendChild(s),r.queryId("pluginSwitchButton4").checked=o;const c=g(5,"　通知");e.appendChild(c),r.queryId("pluginSwitchButton5").checked=a;const p=g(1,"　定期リロード");e.appendChild(p),p.addEventListener("change",(e=>{e.target.checked?(v(),u=window.setInterval(v,1e3*i)):(r.queryId("pluginSwitchMessage").innerHTML="&nbsp;",window.clearInterval(u),u=0,document.title=m)}));const d=f().appendChild(t.create("span").prop({id:"pluginSwitchMessage",style:{color:"white"}}).text("　"));if(e.appendChild(d),l){const r=f().appendChild(t.create("a").prop({id:"pluginVersionUpMessage",href:"https://github.com/ShigeUe/MentorCheckEx"}).text("MentorCheckExの\n新バージョンあり"));e.appendChild(r)}w(!1)})()})()})();