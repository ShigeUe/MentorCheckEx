"use strict";import{CurriculumIdToData,ReviewCodes}from"../curriculum_codes.js";(async()=>{let e;const t=e=>e.replace(/\/\*[\s\S]+?\*\//g,(e=>{const t=e.split("\n").length-1;return"\n".repeat(t)})).replace(/\<\!\-\-[\s\S]*?\-\-\>/g,(e=>{const t=e.split("\n").length-1;return"\n".repeat(t)})).replace(/(?<!https*:)\/\/.+(\r\n|\n|\r})/g,"\n").replace(/\n +\n/g,"\n\n"),n=e=>e.replace(/^ *\n+/g,"").replace(/\n+[\s\n]*\n+/g,"\n").replace(/\n+/g,"\n"),r=(t,n)=>{let r=document.createElement("div");r.innerHTML=t.replace(/#(\d+)#/g,"<a href='#'>$1</a>").replace(/#do#/,"<button>実行</button>"),document.querySelector(".header .message_area").append(r),r.querySelectorAll("a").forEach((t=>{t.addEventListener("click",(t=>{t.preventDefault(),e.scrollTo("lhs",parseInt(t.currentTarget.textContent))}))})),r.querySelectorAll("button").forEach((e=>{e.addEventListener("click",n)}))},l=e=>{const t=e.split("\n");for(let e=0;e<t.length;e++)t[e]=t[e].substring(1).trim();return t.join(" ")},a=e=>e.replace(/\s+/g," ").replace(/(?<=^|[\(\)\{\}\<\>,]) | (?=$|[\(\)\{\}\<\>,])/g,""),c=e=>e.replace(/(?<= )\.(?=\d)/g,"0."),s=t=>{const[n,r]=t.trim().split("c"),l=e.get("lhs").split("\n"),a=e.get("rhs").split("\n");let[c,s]=n.split(","),[o,i]=r.split(",");s=s??c,i=i??o;let d="";for(let e=c-1;e<s;e++)d+=l[e]+"\n";a.splice(o-1,i-o+1,d.trimEnd()),e.once("updated",(()=>{e.scrollTo("rhs",parseInt(o)),e.scrollTo("lhs",parseInt(c))})),e.rhs(a.join("\n"))},o=()=>{const t=e.diff().trim();if(document.querySelector(".header .message_area").innerHTML="",!t)return;let n=e.get("lhs");e.get("rhs"),n.includes("　")&&r("全角スペースを「□」に置き換える #do#",(()=>{e.lhs(n.replace(/　/g,"□"))}));const o=t.split(/^(?=\d)|(?<=^\d.*)\n/m);for(let e=0;e<o.length;e+=2)if(o[e].match(/^[\d,]+c[\d,]+$/)){const t=o[e].split(/[,c]/).shift();let[n,i]=o[e+1].split(/---\n/m);n=a(l(n.trim())),i=a(l(i.trim())),n==i&&r(`#${t}#: 1行にすると一致 #do#`,(()=>{s(o[e])})),(n.match(/ \.\d+/)||i.match(/ \.\d+/))&&c(n.trim())==c(i.trim())&&r(`#${t}#: 値に0を付けると一致 #do#`,(()=>{s(o[e])}))}},i=new URL(location.href),d=i.searchParams.get("id"),u=i.searchParams.get("folder"),m=i.searchParams.get("c_id"),h=`https://a7.sakuratan.com/gdrive/${d}/${u}/`,g=`https://a7.sakuratan.com/7e9a64a25f27ee0397c8b11131328e9b/get.php?p=${d}/${u}/`;let p;await(async()=>{const e=await fetch("/mentor/users/"+i.searchParams.get("user")),t=await e.text(),n=(new DOMParser).parseFromString(t,"text/html");return p=n.querySelector("h2.heading-users").innerText,document.querySelector(".labels .student").innerHTML=`<a href="${h}" target="_blank" title="プレビュー">${p}さんのプレビュー</a>`,n.querySelector('[href^="https://drive.google.com/drive/"]:has(i)').href})();const f=await fetch(`https://a7.sakuratan.com/7e9a64a25f27ee0397c8b11131328e9b/sync.php?id=${d}&f=${u}`,{credentials:"include",cache:"no-cache",mode:"cors"}),y=await f.json();if("404"==y.code)return void(document.getElementById("mergely").innerHTML=`<p style="color:red;font-weight:bold">${p}さんの"${d}/${u}"フォルダがありません。`);console.log("ProcessingTime:"+y.processingTime),console.log("[rclone output]\n"+y.output);const v={};document.getElementById("diffFromGit").value-0?(document.getElementById("whenDiffFromGit").innerText="　from GitHub",await ReviewCodes.getCodesFromGit()):await ReviewCodes.getCodes();let I="";if(ReviewCodes.codes[m])for(let e of ReviewCodes.codes[m]){let r=n(t(e.code.trim()));I+=`### ${e.file}\n${r}\n\n\n\n\n`}let E="";for(let e of CurriculumIdToData[m].files){const r=`${g}${e}`;let l;try{l=await fetch(r,{credentials:"include",cache:"no-cache",mode:"cors"})}catch(e){console.log(e)}const a=r.split("/").pop();let c;c=l?await l.text():"",v[(T=a,T.split(".").pop())]=c,c=n(t(c.trim())),E+=`### ${a}\n${c}\n\n\n\n\n`}var T;if((v.html||v.css)&&(document.getElementById("VALIDATOR-LINK").addEventListener("click",(e=>{e.preventDefault(),v.html&&(e=>{const t=document.getElementById("HTML-VALIDATOR-FORM");t.content.value=e,t.submit()})(v.html),v.css&&(e=>{const t=document.getElementById("CSS-VALIDATOR-FORM");t.text.value=e,t.submit()})(v.css)})),document.getElementById("VALIDATOR-LINK").style.display="inline"),document.getElementById("MAX-SCREEN").addEventListener("click",(t=>{t.preventDefault();const n=e.cm("lhs").lastLine(),r=e.cm("rhs").lastLine(),l=18*((n>r?n:r)+10),a=document.getElementById("mergely");return t.currentTarget.innerText=a.style.height?"mergelyの高さを最大化":"mergelyの高さを戻す",a.style.height=a.style.height?"":l+"px",e.resize(),!1})),document.title=`${p}さんの課題レビュー`,!ReviewCodes.codes[m])return document.getElementById("mergely").innerHTML=`<h3>${p}さんの課題</h3><p><strong>「${CurriculumIdToData[m].title}」</strong></p>\n      <p><code><a href="https://drive.google.com/drive/folders/${d}?usp=drive_link" target="_blank">/${d}</a>/${u}</code></p>\n      <p>この課題はコードの比較は出来ません。<br>直接プレビューしましょう。</p>\n      <ul>\n      <li><a href="${h}${CurriculumIdToData[m]?.files[0]}" target="_blank">プレビューを開く</a></li>\n      <li><a href="javascript:document.getElementById('VALIDATOR-LINK').click()">バリデータを開く</a></li>\n      `+("kadai-final-exam"==m?'<li><a href="#" id="FINAL-EXAM-CHECK-LINK">最終課題チェッカー</a></li>':"")+("kadai-css"==m?`<li><a href="${h}style.css" target="_blank">style.cssを開く</a></li>`:"")+(m.match(/jquery/)?`<li><a href="${h}main.js" target="_blank">main.jsを開く</a></li>`:"")+(CurriculumIdToData[m].demo?`<li><a href="${CurriculumIdToData[m].demo}" target="_blank">デモページ</a></li>`:"")+(CurriculumIdToData[m].description?`<li>${CurriculumIdToData[m].description}</li>`:"")+"</ul>",void("kadai-final-exam"==m&&document.getElementById("FINAL-EXAM-CHECK-LINK").addEventListener("click",(e=>{e.preventDefault(),((e,t,n)=>{const r=document.getElementById("FINAL-EXAM-CHECKER");r.html.value=e,r.css.value=t,r.js.value=n,r.submit()})(v?.html,v?.css,v?.js)})));document.getElementById("NOW-LOADING").remove(),document.querySelector("#page-content-wrapper > .container-fluid > .row > .col-lg-12 .header").style.visibility="visible",e=new Mergely("#mergely",{ignorews:!0}),window.G_MERGELY=e,e.once("updated",(()=>{var t,n;n=I,(t=E)&&e.lhs(t),e.rhs(n),setTimeout((()=>{o(),e.options({line_numbers:!1,sidebar:!1})}),500)})),setTimeout((()=>{document.querySelector(".mergely-splash")?.click()}),2e3),e.on("updated",(()=>{const t=e.summary();document.querySelector(".header .controller .numChanges").innerText=t.numChanges?t.numChanges+" diffs":"No diffs",o()})),document.querySelectorAll(".header .controller .prev,.header .controller .next").forEach((t=>{t.addEventListener("click",(t=>(t.preventDefault(),t.target.classList.contains("next")?e.scrollToDiff("next"):e.scrollToDiff("prev"),!1)))})),document.querySelectorAll('input[type="checkbox"]').forEach((t=>{t.addEventListener("change",(t=>{const n={};n[t.target.id]=t.target.checked,e.options(n)}))}))})();