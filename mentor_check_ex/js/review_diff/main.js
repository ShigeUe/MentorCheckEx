"use strict";import{CurriculumIdToData,ReviewCodes}from"../curriculum_codes.js";(async()=>{const e=location.href.match(/first-sidejob-(\d+?)/);if(!e)return;let t;Number(e[1])>2&&(CurriculumIdToData["kadai-smartphone-1"].files=["index.html","css/style.css","js/main.js"],CurriculumIdToData["kadai-smartphone-2"].files=["index.html","css/style.css","js/main.js"]);const n=e=>e.replace(/\/\*[\s\S]+?\*\//g,(e=>{const t=e.split("\n").length-1;return"\n".repeat(t)})).replace(/\<\!\-\-[\s\S]*?\-\-\>/g,(e=>{const t=e.split("\n").length-1;return"\n".repeat(t)})).replace(/(?<!https*:)\/\/.+(\r\n|\n|\r})/g,"\n").replace(/\n +\n/g,"\n\n"),r=e=>e.replace(/^ *\n+/g,"").replace(/\n+[\s\n]*\n+/g,"\n").replace(/\n+/g,"\n"),l=()=>({s_code:t.get("lhs"),c_code:t.get("rhs")}),c=(e,n)=>{e&&t.lhs(e),t.rhs(n)},s=(e,n)=>{let r=document.createElement("div");r.innerHTML=e.replace(/#(\d+)#/g,"<a href='#'>$1</a>").replace(/#do#/,"<button>実行</button>"),document.querySelector(".header .message_area").append(r),r.querySelectorAll("a").forEach((e=>{e.addEventListener("click",(e=>{e.preventDefault(),t.scrollTo("lhs",parseInt(e.currentTarget.textContent))}))})),r.querySelectorAll("button").forEach((e=>{e.addEventListener("click",n)}))},a=e=>{const t=e.split("\n");for(let e=0;e<t.length;e++)t[e]=t[e].substring(1).trim();return t.join(" ")},o=e=>e.replace(/\s+/g," ").replace(/(?<=^|[\(\)\{\}\<\>,]) | (?=$|[\(\)\{\}\<\>,])/g,""),i=e=>e.replace(/(?<= )\.(?=\d)/g,"0."),d=e=>{const[n,r]=e.trim().split("c"),{s_code:c,c_code:s}=l(),a=c.split("\n"),o=s.split("\n");let[i,d]=n.split(","),[u,m]=r.split(",");d=d??i,m=m??u;let h="";for(let e=i-1;e<d;e++)h+=a[e]+"\n";o.splice(u-1,m-u+1,h.trimEnd()),t.once("updated",(()=>{t.scrollTo("rhs",parseInt(u)),t.scrollTo("lhs",parseInt(i))})),t.rhs(o.join("\n"))},u=()=>{const e=t.diff().trim();if(document.querySelector(".header .message_area").innerHTML="",!e)return;let{s_code:n}=l();n.includes("　")&&s("全角スペースを「□」に置き換える #do#",(()=>{t.lhs(n.replace(/　/g,"□"))}));const r=e.split(/^(?=\d)|(?<=^\d.*)\n/m);for(let e=0;e<r.length;e+=2)if(r[e].match(/^[\d,]+c[\d,]+$/)){const t=r[e].split(/[,c]/).shift();let[n,l]=r[e+1].split(/---\n/m);n=o(a(n.trim())),l=o(a(l.trim()));const[c,u]=r[e].split("c");n==l&&(!c.includes(",")&&u.includes(",")||c.includes(",")&&!u.includes(","))&&s(`#${t}#: 1行にすると一致 #do#`,(()=>{d(r[e])})),(n.match(/ \.\d+/)||l.match(/ \.\d+/))&&i(n.trim())==i(l.trim())&&s(`#${t}#: 値に0を付けると一致 #do#`,(()=>{d(r[e])}))}},m=new URL(location.href),h=m.searchParams.get("id"),p=m.searchParams.get("folder"),g=m.searchParams.get("c_id"),f=`https://a7.sakuratan.com/gdrive/${h}/${p}/`,y=`https://a7.sakuratan.com/7e9a64a25f27ee0397c8b11131328e9b/get.php?p=${h}/${p}/`;let E;await(async()=>{const e=await fetch("/mentor/users/"+m.searchParams.get("user")),t=await e.text(),n=(new DOMParser).parseFromString(t,"text/html");return E=n.querySelector("h2.heading-users").innerText,document.querySelector(".labels .student").innerHTML=`<a href="${f}" target="_blank" title="プレビュー">${E}さんのプレビュー</a>`,n.querySelector('[href^="https://drive.google.com/drive/"]:has(i)').href})();const v=await fetch(`https://a7.sakuratan.com/7e9a64a25f27ee0397c8b11131328e9b/sync.php?id=${h}&f=${p}`,{credentials:"include",cache:"no-cache",mode:"cors"}),I=await v.json();if("404"==I.code)return void(document.getElementById("mergely").innerHTML=`<p style="color:red;font-weight:bold">${E}さんの"${h}/${p}"フォルダがありません。`);console.log("ProcessingTime:"+I.processingTime),console.log("[rclone output]\n"+I.output);const T={};document.getElementById("diffFromGit").value-0?(document.getElementById("whenDiffFromGit").innerText="　from GitHub",await ReviewCodes.getCodesFromGit()):await ReviewCodes.getCodes();let $="";if(ReviewCodes.codes[g])for(let e of ReviewCodes.codes[g]){let t=r(n(e.code.trim()));$+=`### ${e.file}\n${t}\n\n\n\n\n`}let L="";for(let e of CurriculumIdToData[g].files){const t=`${y}${e}`;let l;try{l=await fetch(t,{credentials:"include",cache:"no-cache",mode:"cors"})}catch(e){console.log(e)}const c=t.split("/").pop();let s;s=l?await l.text():"",T[(C=c,C.split(".").pop())]=s,s=r(n(s.trim())),L+=`### ${c}\n${s}\n\n\n\n\n`}var C;if((T.html||T.css)&&(document.getElementById("VALIDATOR-LINK").addEventListener("click",(e=>{e.preventDefault(),T.html&&(e=>{const t=document.getElementById("HTML-VALIDATOR-FORM");t.content.value=e,t.submit()})(T.html),T.css&&(e=>{const t=document.getElementById("CSS-VALIDATOR-FORM");t.text.value=e,t.submit()})(T.css)})),document.getElementById("VALIDATOR-LINK").style.display="inline"),document.getElementById("MAX-SCREEN").addEventListener("click",(e=>{e.preventDefault();const n=t.cm("lhs").lastLine(),r=t.cm("rhs").lastLine(),l=18*((n>r?n:r)+10),c=document.getElementById("mergely");return e.currentTarget.innerText=c.style.height?"mergelyの高さを最大化":"mergelyの高さを戻す",c.style.height=c.style.height?"":l+"px",t.resize(),!1})),document.title=`${E}さんの課題レビュー`,!ReviewCodes.codes[g])return document.getElementById("mergely").innerHTML=`<h3>${E}さんの課題</h3><p><strong>「${CurriculumIdToData[g].title}」</strong></p>\n      <p><code><a href="https://drive.google.com/drive/folders/${h}?usp=drive_link" target="_blank">/${h}</a>/${p}</code></p>\n      <p>この課題はコードの比較は出来ません。<br>直接プレビューしましょう。</p>\n      <ul>\n      <li><a href="${f}${CurriculumIdToData[g]?.files[0]}" target="_blank">プレビューを開く</a></li>\n      <li><a href="javascript:document.getElementById('VALIDATOR-LINK').click()">バリデータを開く</a></li>\n      `+("kadai-final-exam"==g?'<li><a href="#" id="FINAL-EXAM-CHECK-LINK">最終課題チェッカー</a></li>':"")+("kadai-css"==g?`<li><a href="${f}style.css" target="_blank">style.cssを開く</a></li>`:"")+(g.match(/jquery/)?`<li><a href="${f}main.js" target="_blank">main.jsを開く</a></li>`:"")+(CurriculumIdToData[g].demo?`<li><a href="${CurriculumIdToData[g].demo}" target="_blank">デモページ</a></li>`:"")+(CurriculumIdToData[g].description?`<li>${CurriculumIdToData[g].description}</li>`:"")+"</ul>",void("kadai-final-exam"==g&&document.getElementById("FINAL-EXAM-CHECK-LINK").addEventListener("click",(e=>{e.preventDefault(),((e,t,n)=>{const r=document.getElementById("FINAL-EXAM-CHECKER");r.html.value=e,r.css.value=t,r.js.value=n,r.submit()})(T?.html,T?.css,T?.js)})));document.getElementById("NOW-LOADING").remove(),document.querySelector("#page-content-wrapper > .container-fluid > .row > .col-lg-12 .header").style.visibility="visible",t=new Mergely("#mergely",{ignorews:!0}),window.G_MERGELY=t,t.once("updated",(()=>{c(L,$),setTimeout((()=>{u(),t.options({line_numbers:!1,sidebar:!1})}),500)})),setTimeout((()=>{document.querySelector(".mergely-splash")?.click()}),2e3),t.on("updated",(()=>{const e=t.summary();document.querySelector(".header .controller .numChanges").innerText=e.numChanges?e.numChanges+" diffs":"No diffs",u()})),document.querySelectorAll(".header .controller .prev,.header .controller .next").forEach((e=>{e.addEventListener("click",(e=>(e.preventDefault(),e.target.classList.contains("next")?t.scrollToDiff("next"):t.scrollToDiff("prev"),!1)))})),document.querySelectorAll('input[type="checkbox"]').forEach((e=>{e.addEventListener("change",(e=>{const n={};document.querySelectorAll('input[type="checkbox"]').forEach((e=>n[e.id]=e.checked)),t.options(n)}))})),document.getElementById("REMOVE-INDENT").addEventListener("click",(e=>{e.preventDefault();const{s_code:t,c_code:n}=l(),r=t.split("\n"),s=n.split("\n");r.forEach(((e,t)=>r[t]=e.trimStart())),s.forEach(((e,t)=>s[t]=e.trimStart())),c(r.join("\n"),s.join("\n")),window.setTimeout((()=>{const e=document.getElementById("ignorews");e.checked=!1,e.dispatchEvent(new Event("change"))}),100)}))})();