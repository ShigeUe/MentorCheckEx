"use strict";import{CurriculumIdToData,ReviewCodes}from"../curriculum_codes.js";(async()=>{const e=location.href.match(/first-sidejob-(\d+?)/);if(!e)return;const t=e[0];let n;const r=e=>e.replace(/\/\*[\s\S]+?\*\//g,(e=>{const t=e.split("\n").length-1;return"\n".repeat(t)})).replace(/\<\!\-\-[\s\S]*?\-\-\>/g,(e=>{const t=e.split("\n").length-1;return"\n".repeat(t)})).replace(/(?<!https*:)\/\/.+(\r\n|\n|\r})/g,"\n").replace(/\n +\n/g,"\n\n"),l=e=>e.replace(/^ *\n+/g,"").replace(/\n+[\s\n]*\n+/g,"\n").replace(/\n+/g,"\n"),c=()=>({s_code:n.get("lhs"),c_code:n.get("rhs")}),o=(e,t)=>{e&&n.lhs(e),n.rhs(t)},s=(e,t)=>{let r=document.createElement("div");r.innerHTML=e.replace(/#(\d+)#/g,"<a href='#'>$1</a>").replace(/#do#/,"<button>実行</button>"),document.querySelector(".header .message_area").append(r),r.querySelectorAll("a").forEach((e=>{e.addEventListener("click",(e=>{e.preventDefault(),n.scrollTo("lhs",parseInt(e.currentTarget.textContent))}))})),r.querySelectorAll("button").forEach((e=>{e.addEventListener("click",t)}))},a=e=>{const t=e.split("\n");for(let e=0;e<t.length;e++)t[e]=t[e].substring(1).trim();return t.join(" ")},i=e=>e.replace(/\s+/g," ").replace(/(?<=^|[\(\)\{\}\<\>,]) | (?=$|[\(\)\{\}\<\>,])/g,""),d=e=>e.replace(/(?<= )\.(?=\d)/g,"0."),u=e=>{const[t,r]=e.trim().split("c"),{s_code:l,c_code:o}=c(),s=l.split("\n"),a=o.split("\n");let[i,d]=t.split(","),[u,m]=r.split(",");d=d??i,m=m??u;let h="";for(let e=i-1;e<d;e++)h+=s[e]+"\n";a.splice(u-1,m-u+1,h.trimEnd()),n.once("updated",(()=>{n.scrollTo("rhs",parseInt(u)),n.scrollTo("lhs",parseInt(i))})),n.rhs(a.join("\n"))},m=()=>{const e=n.diff().trim();if(document.querySelector(".header .message_area").innerHTML="",!e)return;let{s_code:t}=c();t.includes("　")&&s("全角スペースを「□」に置き換える #do#",(()=>{n.lhs(t.replace(/　/g,"□"))}));const r=e.split(/^(?=\d)|(?<=^\d.*)\n/m);for(let e=0;e<r.length;e+=2)if(r[e].match(/^[\d,]+c[\d,]+$/)){const t=r[e].split(/[,c]/).shift();let[n,l]=r[e+1].split(/---\n/m);n=i(a(n.trim())),l=i(a(l.trim()));const[c,o]=r[e].split("c");n==l&&(!c.includes(",")&&o.includes(",")||c.includes(",")&&!o.includes(","))&&s(`#${t}#: 1行にすると一致 #do#`,(()=>{u(r[e])})),(n.match(/ \.\d+/)||l.match(/ \.\d+/))&&d(n.trim())==d(l.trim())&&s(`#${t}#: 値に0を付けると一致 #do#`,(()=>{u(r[e])}))}},h=new URL(location.href),p=h.searchParams.get("id"),g=h.searchParams.get("folder"),f=h.searchParams.get("c_id"),y=`https://a7.sakuratan.com/gdrive/${p}/${g}/`,E=`https://a7.sakuratan.com/7e9a64a25f27ee0397c8b11131328e9b/get.php?p=${p}/${g}/`;let v;await(async()=>{const e=await fetch("/mentor/users/"+h.searchParams.get("user")),t=await e.text(),n=(new DOMParser).parseFromString(t,"text/html");return v=n.querySelector("h2.heading-users").innerText,document.querySelector(".labels .student").innerHTML=`<a href="${y}" target="_blank" title="プレビュー">${v}さんのプレビュー</a>`,n.querySelector('[href^="https://drive.google.com/drive/"]:has(i)').href})();const I=await fetch(`https://a7.sakuratan.com/7e9a64a25f27ee0397c8b11131328e9b/sync.php?id=${p}&f=${g}`,{credentials:"include",cache:"no-cache",mode:"cors"}),T=await I.json();if("404"==T.code)return void(document.getElementById("mergely").innerHTML=`<p style="color:red;font-weight:bold">${v}さんの"${p}/${g}"フォルダがありません。`);console.log("ProcessingTime:"+T.processingTime),console.log("[rclone output]\n"+T.output);const $={};document.getElementById("diffFromGit").value-0?(document.getElementById("whenDiffFromGit").innerText="　from GitHub",await ReviewCodes.getCodesFromGit()):await ReviewCodes.getCodes();let L="";if(ReviewCodes.codes[f])for(let e of ReviewCodes.codes[f]){let t=l(r(e.code.trim()));L+=`### ${e.file}\n${t}\n\n\n\n\n`}let w="";for(let e of CurriculumIdToData[t][f].files){const t=`${E}${e}`;let n;try{n=await fetch(t,{credentials:"include",cache:"no-cache",mode:"cors"})}catch(e){console.log(e)}const c=t.split("/").pop();let o;o=n?await n.text():"",$[(b=c,b.split(".").pop())]=o,o=l(r(o.trim())),w+=`### ${c}\n${o}\n\n\n\n\n`}var b;if(($.html||$.css)&&(document.getElementById("VALIDATOR-LINK").addEventListener("click",(e=>{e.preventDefault(),$.html&&(e=>{const t=document.getElementById("HTML-VALIDATOR-FORM");t.content.value=e,t.submit()})($.html),$.css&&(e=>{const t=document.getElementById("CSS-VALIDATOR-FORM");t.text.value=e,t.submit()})($.css)})),document.getElementById("VALIDATOR-LINK").style.display="inline"),document.getElementById("MAX-SCREEN").addEventListener("click",(e=>{e.preventDefault();const t=n.cm("lhs").lastLine(),r=n.cm("rhs").lastLine(),l=18*((t>r?t:r)+10),c=document.getElementById("mergely");return e.currentTarget.innerText=c.style.height?"mergelyの高さを最大化":"mergelyの高さを戻す",c.style.height=c.style.height?"":l+"px",n.resize(),!1})),document.title=`${v}さんの課題レビュー`,!ReviewCodes.codes[f])return document.getElementById("mergely").innerHTML=`<h3>${v}さんの課題</h3><p><strong>「${CurriculumIdToData[t][f].title}」</strong></p>\n      <p><code><a href="https://drive.google.com/drive/folders/${p}?usp=drive_link" target="_blank">/${p}</a>/${g}</code></p>\n      <p>この課題はコードの比較は出来ません。<br>直接プレビューしましょう。</p>\n      <ul>\n      <li><a href="${y}${CurriculumIdToData[t][f]?.files[0]}" target="_blank">プレビューを開く</a></li>\n      <li><a href="javascript:document.getElementById('VALIDATOR-LINK').click()">バリデータを開く</a></li>\n      `+("kadai-final-exam"==f?'<li><a href="#" id="FINAL-EXAM-CHECK-LINK">最終課題チェッカー</a></li>':"")+("kadai-css"==f?`<li><a href="${y}style.css" target="_blank">style.cssを開く</a></li>`:"")+(f.match(/jquery/)?`<li><a href="${y}main.js" target="_blank">main.jsを開く</a></li>`:"")+(CurriculumIdToData[t][f].demo?`<li><a href="${CurriculumIdToData[t][f].demo}" target="_blank">デモページ</a></li>`:"")+(CurriculumIdToData[t][f].description?`<li>${CurriculumIdToData[t][f].description}</li>`:"")+"</ul>",void("kadai-final-exam"==f&&document.getElementById("FINAL-EXAM-CHECK-LINK").addEventListener("click",(e=>{e.preventDefault(),((e,t,n)=>{const r=document.getElementById("FINAL-EXAM-CHECKER");r.html.value=e,r.css.value=t,r.js.value=n,r.submit()})($?.html,$?.css,$?.js)})));document.getElementById("NOW-LOADING").remove(),document.querySelector("#page-content-wrapper > .container-fluid > .row > .col-lg-12 .header").style.visibility="visible",n=new Mergely("#mergely",{ignorews:!0}),window.G_MERGELY=n,n.once("updated",(()=>{o(w,L),setTimeout((()=>{m(),n.options({line_numbers:!1,sidebar:!1})}),500)})),setTimeout((()=>{document.querySelector(".mergely-splash")?.click()}),2e3),n.on("updated",(()=>{const e=n.summary();document.querySelector(".header .controller .numChanges").innerText=e.numChanges?e.numChanges+" diffs":"No diffs",m()})),document.querySelectorAll(".header .controller .prev,.header .controller .next").forEach((e=>{e.addEventListener("click",(e=>(e.preventDefault(),e.target.classList.contains("next")?n.scrollToDiff("next"):n.scrollToDiff("prev"),!1)))})),document.querySelectorAll('input[type="checkbox"]').forEach((e=>{e.addEventListener("change",(e=>{const t={};document.querySelectorAll('input[type="checkbox"]').forEach((e=>t[e.id]=e.checked)),n.options(t)}))})),document.getElementById("REMOVE-INDENT").addEventListener("click",(e=>{e.preventDefault();const{s_code:t,c_code:n}=c(),r=t.split("\n"),l=n.split("\n");r.forEach(((e,t)=>r[t]=e.trimStart())),l.forEach(((e,t)=>l[t]=e.trimStart())),o(r.join("\n"),l.join("\n")),window.setTimeout((()=>{const e=document.getElementById("ignorews");e.checked=!1,e.dispatchEvent(new Event("change"))}),100)}))})();