"use strict";import{CurriculumIdToData,ReviewCodes}from"../curriculum_codes.js";(async()=>{let e;const t=e=>e.replace(/\/\*[\s\S]+?\*\//g,(e=>{const t=e.split("\n").length-1;return"\n".repeat(t)})).replace(/\<\!\-\-[\s\S]*?\-\-\>/g,(e=>{const t=e.split("\n").length-1;return"\n".repeat(t)})).replace(/(?<!https*:)\/\/.+(\r\n|\n|\r})/g,"\n").replace(/\n +\n/g,"\n\n"),n=e=>e.replace(/^ *\n+/g,"").replace(/\n+[\s\n]*\n+/g,"\n").replace(/\n+/g,"\n"),r=()=>({s_code:e.get("lhs"),c_code:e.get("rhs")}),l=(t,n)=>{t&&e.lhs(t),e.rhs(n)},c=(t,n)=>{let r=document.createElement("div");r.innerHTML=t.replace(/#(\d+)#/g,"<a href='#'>$1</a>").replace(/#do#/,"<button>実行</button>"),document.querySelector(".header .message_area").append(r),r.querySelectorAll("a").forEach((t=>{t.addEventListener("click",(t=>{t.preventDefault(),e.scrollTo("lhs",parseInt(t.currentTarget.textContent))}))})),r.querySelectorAll("button").forEach((e=>{e.addEventListener("click",n)}))},o=e=>{const t=e.split("\n");for(let e=0;e<t.length;e++)t[e]=t[e].substring(1).trim();return t.join(" ")},a=e=>e.replace(/\s+/g," ").replace(/(?<=^|[\(\)\{\}\<\>,]) | (?=$|[\(\)\{\}\<\>,])/g,""),s=e=>e.replace(/(?<= )\.(?=\d)/g,"0."),i=t=>{const[n,l]=t.trim().split("c"),{s_code:c,c_code:o}=r(),a=c.split("\n"),s=o.split("\n");let[i,d]=n.split(","),[u,m]=l.split(",");d=d??i,m=m??u;let h="";for(let e=i-1;e<d;e++)h+=a[e]+"\n";s.splice(u-1,m-u+1,h.trimEnd()),e.once("updated",(()=>{e.scrollTo("rhs",parseInt(u)),e.scrollTo("lhs",parseInt(i))})),e.rhs(s.join("\n"))},d=()=>{const t=e.diff().trim();if(document.querySelector(".header .message_area").innerHTML="",!t)return;let{s_code:n}=r();n.includes("　")&&c("全角スペースを「□」に置き換える #do#",(()=>{e.lhs(n.replace(/　/g,"□"))}));const l=t.split(/^(?=\d)|(?<=^\d.*)\n/m);for(let e=0;e<l.length;e+=2)if(l[e].match(/^[\d,]+c[\d,]+$/)){const t=l[e].split(/[,c]/).shift();let[n,r]=l[e+1].split(/---\n/m);n=a(o(n.trim())),r=a(o(r.trim()));const[d,u]=l[e].split("c");n==r&&(!d.includes(",")&&u.includes(",")||d.includes(",")&&!u.includes(","))&&c(`#${t}#: 1行にすると一致 #do#`,(()=>{i(l[e])})),(n.match(/ \.\d+/)||r.match(/ \.\d+/))&&s(n.trim())==s(r.trim())&&c(`#${t}#: 値に0を付けると一致 #do#`,(()=>{i(l[e])}))}},u=new URL(location.href),m=u.searchParams.get("id"),h=u.searchParams.get("folder"),p=u.searchParams.get("c_id"),g=`https://a7.sakuratan.com/gdrive/${m}/${h}/`,f=`https://a7.sakuratan.com/7e9a64a25f27ee0397c8b11131328e9b/get.php?p=${m}/${h}/`;let y;await(async()=>{const e=await fetch("/mentor/users/"+u.searchParams.get("user")),t=await e.text(),n=(new DOMParser).parseFromString(t,"text/html");return y=n.querySelector("h2.heading-users").innerText,document.querySelector(".labels .student").innerHTML=`<a href="${g}" target="_blank" title="プレビュー">${y}さんのプレビュー</a>`,n.querySelector('[href^="https://drive.google.com/drive/"]:has(i)').href})();const E=await fetch(`https://a7.sakuratan.com/7e9a64a25f27ee0397c8b11131328e9b/sync.php?id=${m}&f=${h}`,{credentials:"include",cache:"no-cache",mode:"cors"}),v=await E.json();if("404"==v.code)return void(document.getElementById("mergely").innerHTML=`<p style="color:red;font-weight:bold">${y}さんの"${m}/${h}"フォルダがありません。`);console.log("ProcessingTime:"+v.processingTime),console.log("[rclone output]\n"+v.output);const I={};document.getElementById("diffFromGit").value-0?(document.getElementById("whenDiffFromGit").innerText="　from GitHub",await ReviewCodes.getCodesFromGit()):await ReviewCodes.getCodes();let T="";if(ReviewCodes.codes[p])for(let e of ReviewCodes.codes[p]){let r=n(t(e.code.trim()));T+=`### ${e.file}\n${r}\n\n\n\n\n`}let $="";for(let e of CurriculumIdToData[p].files){const r=`${f}${e}`;let l;try{l=await fetch(r,{credentials:"include",cache:"no-cache",mode:"cors"})}catch(e){console.log(e)}const c=r.split("/").pop();let o;o=l?await l.text():"",I[(L=c,L.split(".").pop())]=o,o=n(t(o.trim())),$+=`### ${c}\n${o}\n\n\n\n\n`}var L;if((I.html||I.css)&&(document.getElementById("VALIDATOR-LINK").addEventListener("click",(e=>{e.preventDefault(),I.html&&(e=>{const t=document.getElementById("HTML-VALIDATOR-FORM");t.content.value=e,t.submit()})(I.html),I.css&&(e=>{const t=document.getElementById("CSS-VALIDATOR-FORM");t.text.value=e,t.submit()})(I.css)})),document.getElementById("VALIDATOR-LINK").style.display="inline"),document.getElementById("MAX-SCREEN").addEventListener("click",(t=>{t.preventDefault();const n=e.cm("lhs").lastLine(),r=e.cm("rhs").lastLine(),l=18*((n>r?n:r)+10),c=document.getElementById("mergely");return t.currentTarget.innerText=c.style.height?"mergelyの高さを最大化":"mergelyの高さを戻す",c.style.height=c.style.height?"":l+"px",e.resize(),!1})),document.title=`${y}さんの課題レビュー`,!ReviewCodes.codes[p])return document.getElementById("mergely").innerHTML=`<h3>${y}さんの課題</h3><p><strong>「${CurriculumIdToData[p].title}」</strong></p>\n      <p><code><a href="https://drive.google.com/drive/folders/${m}?usp=drive_link" target="_blank">/${m}</a>/${h}</code></p>\n      <p>この課題はコードの比較は出来ません。<br>直接プレビューしましょう。</p>\n      <ul>\n      <li><a href="${g}${CurriculumIdToData[p]?.files[0]}" target="_blank">プレビューを開く</a></li>\n      <li><a href="javascript:document.getElementById('VALIDATOR-LINK').click()">バリデータを開く</a></li>\n      `+("kadai-final-exam"==p?'<li><a href="#" id="FINAL-EXAM-CHECK-LINK">最終課題チェッカー</a></li>':"")+("kadai-css"==p?`<li><a href="${g}style.css" target="_blank">style.cssを開く</a></li>`:"")+(p.match(/jquery/)?`<li><a href="${g}main.js" target="_blank">main.jsを開く</a></li>`:"")+(CurriculumIdToData[p].demo?`<li><a href="${CurriculumIdToData[p].demo}" target="_blank">デモページ</a></li>`:"")+(CurriculumIdToData[p].description?`<li>${CurriculumIdToData[p].description}</li>`:"")+"</ul>",void("kadai-final-exam"==p&&document.getElementById("FINAL-EXAM-CHECK-LINK").addEventListener("click",(e=>{e.preventDefault(),((e,t,n)=>{const r=document.getElementById("FINAL-EXAM-CHECKER");r.html.value=e,r.css.value=t,r.js.value=n,r.submit()})(I?.html,I?.css,I?.js)})));document.getElementById("NOW-LOADING").remove(),document.querySelector("#page-content-wrapper > .container-fluid > .row > .col-lg-12 .header").style.visibility="visible",e=new Mergely("#mergely",{ignorews:!0}),window.G_MERGELY=e,e.once("updated",(()=>{l($,T),setTimeout((()=>{d(),e.options({line_numbers:!1,sidebar:!1})}),500)})),setTimeout((()=>{document.querySelector(".mergely-splash")?.click()}),2e3),e.on("updated",(()=>{const t=e.summary();document.querySelector(".header .controller .numChanges").innerText=t.numChanges?t.numChanges+" diffs":"No diffs",d()})),document.querySelectorAll(".header .controller .prev,.header .controller .next").forEach((t=>{t.addEventListener("click",(t=>(t.preventDefault(),t.target.classList.contains("next")?e.scrollToDiff("next"):e.scrollToDiff("prev"),!1)))})),document.querySelectorAll('input[type="checkbox"]').forEach((t=>{t.addEventListener("change",(t=>{const n={};document.querySelectorAll('input[type="checkbox"]').forEach((e=>n[e.id]=e.checked)),e.options(n)}))})),document.getElementById("REMOVE-INDENT").addEventListener("click",(e=>{e.preventDefault();const{s_code:t,c_code:n}=r(),c=t.split("\n"),o=n.split("\n");c.forEach(((e,t)=>c[t]=e.trimStart())),o.forEach(((e,t)=>o[t]=e.trimStart())),l(c.join("\n"),o.join("\n")),window.setTimeout((()=>{const e=document.getElementById("ignorews");e.checked=!1,e.dispatchEvent(new Event("change"))}),100)}))})();