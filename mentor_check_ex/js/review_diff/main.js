"use strict";import{CurriculumIdToData,ReviewCodes}from"../curriculum_codes.js";(async()=>{let e;const t=e=>e.replace(/\/\*[\s\S]+?\*\//g,(e=>{const t=e.split("\n").length-1;return"\n".repeat(t)})).replace(/\<\!\-\-[\s\S]*?\-\-\>/g,(e=>{const t=e.split("\n").length-1;return"\n".repeat(t)})).replace(/(?<!https*:)\/\/.+(\r\n|\n|\r})/g,"\n").replace(/\n +\n/g,"\n\n"),r=e=>e.replace(/^ *\n+/g,"").replace(/\n+[\s\n]*\n+/g,"\n").replace(/\n+/g,"\n"),n=(t,r)=>{let n=document.createElement("div");n.innerHTML=t.replace(/#(\d+)#/g,"<a href='#'>$1</a>").replace(/#do#/,"<button>実行</button>"),document.querySelector(".header .message_area").append(n),n.querySelectorAll("a").forEach((t=>{t.addEventListener("click",(t=>{t.preventDefault(),e.scrollTo("lhs",parseInt(t.currentTarget.textContent))}))})),n.querySelectorAll("button").forEach((e=>{e.addEventListener("click",r)}))},l=e=>{const t=e.split("\n");for(let e=0;e<t.length;e++)t[e]=t[e].substring(1).trim();return t.join(" ")},a=e=>e.replace(/\s+/g," ").replace(/(?<=^|[\(\)\{\}\<\>,]) | (?=$|[\(\)\{\}\<\>,])/g,""),c=e=>e.replace(/(?<= )\.(?=\d)/g,"0."),o=()=>{const t=e.diff().trim();if(document.querySelector(".header .message_area").innerHTML="",!t)return;let r=e.get("lhs");e.get("rhs"),r.includes("　")&&n("全角スペースを「□」に置き換える #do#",(()=>{e.lhs(r.replace(/　/g,"□"))}));const o=t.split(/^(?=\d)|(?<=^\d.*)\n/m);for(let e=0;e<o.length;e+=2)if(o[e].match(/^[\d,]+c[\d,]+$/)){const t=o[e].split(/[,c]/).shift();let[r,s]=o[e+1].split(/---\n/m);r=a(l(r.trim())),s=a(l(s.trim())),r==s&&n(`#${t}#: 1行にすると一致。`),(r.match(/ \.\d+/)||s.match(/ \.\d+/))&&c(r.trim())==c(s.trim())&&n(`#${t}#: 値に0を付けると一致。`)}},s=new URL(location.href),i=s.searchParams.get("id"),d=s.searchParams.get("folder"),u=s.searchParams.get("c_id"),m=`https://a7.sakuratan.com/gdrive/${i}/${d}/`,g=`https://a7.sakuratan.com/7e9a64a25f27ee0397c8b11131328e9b/get.php?p=${i}/${d}/`;let h;await(async()=>{const e=await fetch("/mentor/users/"+s.searchParams.get("user")),t=await e.text(),r=(new DOMParser).parseFromString(t,"text/html");return h=r.querySelector("h2.heading-users").innerText,document.querySelector(".labels .student").innerHTML=`<a href="${m}" target="_blank" title="プレビュー">${h}さんのプレビュー</a>`,r.querySelector('[href^="https://drive.google.com/drive/"]:has(i)').href})();const p=await fetch(`https://a7.sakuratan.com/7e9a64a25f27ee0397c8b11131328e9b/sync.php?id=${i}&f=${d}`,{credentials:"include",cache:"no-cache",mode:"cors"}),f=await p.json();if("404"==f.code)return void(document.getElementById("mergely").innerHTML=`<p style="color:red;font-weight:bold">${h}さんの"${i}/${d}"フォルダがありません。`);console.log("ProcessingTime:"+f.processingTime),console.log("[rclone output]\n"+f.output);const y={};document.getElementById("diffFromGit").value-0?(document.getElementById("whenDiffFromGit").innerText="　from GitHub",await ReviewCodes.getCodesFromGit()):await ReviewCodes.getCodes();let v="";if(ReviewCodes.codes[u])for(let e of ReviewCodes.codes[u]){let n=r(t(e.code.trim()));v+=`### ${e.file}\n${n}\n\n\n\n\n`}let I="";for(let e of CurriculumIdToData[u].files){const n=`${g}${e}`;let l;try{l=await fetch(n,{credentials:"include",cache:"no-cache",mode:"cors"})}catch(e){console.log(e)}const a=n.split("/").pop();let c;c=l?await l.text():"",y[(E=a,E.split(".").pop())]=c,c=r(t(c.trim())),I+=`### ${a}\n${c}\n\n\n\n\n`}var E;if((y.html||y.css)&&(document.getElementById("VALIDATOR-LINK").addEventListener("click",(e=>{e.preventDefault(),y.html&&(e=>{const t=document.getElementById("HTML-VALIDATOR-FORM");t.content.value=e,t.submit()})(y.html),y.css&&(e=>{const t=document.getElementById("CSS-VALIDATOR-FORM");t.text.value=e,t.submit()})(y.css)})),document.getElementById("VALIDATOR-LINK").style.display="inline"),document.getElementById("MAX-SCREEN").addEventListener("click",(t=>{t.preventDefault();const r=e.cm("lhs").lastLine(),n=e.cm("rhs").lastLine(),l=18*((r>n?r:n)+10),a=document.getElementById("mergely");return t.currentTarget.innerText=a.style.height?"mergelyの高さを最大化":"mergelyの高さを戻す",a.style.height=a.style.height?"":l+"px",e.resize(),!1})),document.title=`${h}さんの課題レビュー`,!ReviewCodes.codes[u])return document.getElementById("mergely").innerHTML=`<h3>${h}さんの課題</h3><p><strong>「${CurriculumIdToData[u].title}」</strong></p>\n      <p><code><a href="https://drive.google.com/drive/folders/${i}?usp=drive_link" target="_blank">/${i}</a>/${d}</code></p>\n      <p>この課題はコードの比較は出来ません。<br>直接プレビューしましょう。</p>\n      <ul>\n      <li><a href="${m}${CurriculumIdToData[u]?.files[0]}" target="_blank">プレビューを開く</a></li>\n      <li><a href="javascript:document.getElementById('VALIDATOR-LINK').click()">バリデータを開く</a></li>\n      `+("kadai-final-exam"==u?'<li><a href="#" id="FINAL-EXAM-CHECK-LINK">最終課題チェッカー</a></li>':"")+("kadai-css"==u?`<li><a href="${m}style.css" target="_blank">style.cssを開く</a></li>`:"")+(u.match(/jquery/)?`<li><a href="${m}main.js" target="_blank">main.jsを開く</a></li>`:"")+(CurriculumIdToData[u].demo?`<li><a href="${CurriculumIdToData[u].demo}" target="_blank">デモページ</a></li>`:"")+(CurriculumIdToData[u].description?`<li>${CurriculumIdToData[u].description}</li>`:"")+"</ul>",void("kadai-final-exam"==u&&document.getElementById("FINAL-EXAM-CHECK-LINK").addEventListener("click",(e=>{e.preventDefault(),((e,t,r)=>{const n=document.getElementById("FINAL-EXAM-CHECKER");n.html.value=e,n.css.value=t,n.js.value=r,n.submit()})(y?.html,y?.css,y?.js)})));document.getElementById("NOW-LOADING").remove(),document.querySelector("#page-content-wrapper > .container-fluid > .row > .col-lg-12 .header").style.visibility="visible",e=new Mergely("#mergely",{ignorews:!0}),e.once("updated",(()=>{var t,r;r=v,(t=I)&&e.lhs(t),e.rhs(r),setTimeout((()=>{o(),e.options({line_numbers:!1,sidebar:!1})}),500)})),setTimeout((()=>{document.querySelector(".mergely-splash")?.click()}),2e3),e.on("updated",(()=>{const t=e.summary();document.querySelector(".header .controller .numChanges").innerText=t.numChanges?t.numChanges+" diffs":"No diffs",o()})),document.querySelectorAll(".header .controller .prev,.header .controller .next").forEach((t=>{t.addEventListener("click",(t=>(t.preventDefault(),t.target.classList.contains("next")?e.scrollToDiff("next"):e.scrollToDiff("prev"),!1)))})),document.querySelectorAll('input[type="checkbox"]').forEach((t=>{t.addEventListener("change",(t=>{const r={};r[t.target.id]=t.target.checked,e.options(r)}))}))})();