"use strict";import{CurriculumIdToData,ReviewCodes}from"../curriculum_codes.js";(async()=>{const e=e=>e.replace(/\/\*[\s\S]+?\*\//g,(e=>{const t=e.split("\n").length-1;return"\n".repeat(t)})).replace(/\<\!\-\-[\s\S]*?\-\-\>/g,(e=>{const t=e.split("\n").length-1;return"\n".repeat(t)})).replace(/(?<!https*:)\/\/.+(\r\n|\n|\r})/g,"\n").replace(/\n +\n/g,"\n\n"),t=e=>e.replace(/^ *\n+/g,"").replace(/\n+[\s\n]*\n+/g,"\n").replace(/\n+/g,"\n"),r=()=>({s_code:$("#mergely").mergely("get","lhs"),c_code:$("#mergely").mergely("get","rhs")}),l=(e,t)=>{e&&$("#mergely").mergely("lhs",e),$("#mergely").mergely("rhs",t)},a=(e,t)=>{let r=$("<div>");r.html(e.replace(/#(\d+)#/g,"<a href='#'>$1</a>").replace(/#do#/,"<button>実行</button>")),$(".header .message_area").append(r),$(r).find("a").on("click",(e=>{e.preventDefault(),$("#mergely").mergely("scrollTo","lhs",parseInt(e.currentTarget.textContent))})),$(r).find("button").on("click",t)},n=e=>{const t=e.split("\n");for(let e=0;e<t.length;e++)t[e]=t[e].substring(1).trim();return t.join(" ")},s=e=>e.replace(/\s+/g," ").replace(/(?<=^|[\(\)\{\}\<\>,]) | (?=$|[\(\)\{\}\<\>,])/g,""),c=e=>e.replace(/(?<= )\.(?=\d)/g,"0."),o=()=>{const e=$("#mergely").mergely("diff").trim();if($(".header .message_area").html(""),!e)return;let t=$("#mergely").mergely("get","lhs");$("#mergely").mergely("get","rhs"),t.includes("　")&&a("全角スペースを「□」に置き換える #do#",(()=>{$("#mergely").mergely("lhs",t.replace(/　/g,"□"))}));const r=e.split(/^(?=\d)|(?<=^\d.*)\n/m);for(let e=0;e<r.length;e+=2)if(r[e].match(/^[\d,]+c[\d,]+$/)){const t=r[e].split(/[,c]/).shift();let[l,o]=r[e+1].split(/---\n/m);l=s(n(l.trim())),o=s(n(o.trim())),l==o&&a(`#${t}#: 1行にすると一致。`),(l.match(/ \.\d+/)||o.match(/ \.\d+/))&&c(l.trim())==c(o.trim())&&a(`#${t}#: 値に0を付けると一致。`)}},i=new URL(location.href),m=i.searchParams.get("id"),g=i.searchParams.get("folder"),d=i.searchParams.get("c_id"),u=`https://a7.sakuratan.com/gdrive/${m}/${g}/`,h=`https://a7.sakuratan.com/7e9a64a25f27ee0397c8b11131328e9b/get.php?p=${m}/${g}/`;let p;await(async()=>{const e=await fetch("/mentor/users/"+i.searchParams.get("user")),t=await e.text(),r=$(t);return p=r.find("h2.heading-users").text(),$(".labels .student").html(`<a href="${u}" target="_blank" title="プレビュー">${p}さんのプレビュー</a>`),r.find('[href^="https://drive.google.com/drive/"]:has(i)').get(0).href})();const f=await fetch(`https://a7.sakuratan.com/7e9a64a25f27ee0397c8b11131328e9b/sync.php?id=${m}&f=${g}`,{credentials:"include",cache:"no-cache",mode:"cors"}),y=await f.json();if("404"==y.code)return void $("#mergely").html(`<p style="color:red;font-weight:bold">${p}さんの"${m}/${g}"フォルダがありません。`);console.log("ProcessingTime:"+y.processingTime),console.log("[rclone output]\n"+y.output);const C={};document.getElementById("diffFromGit").value-0?(document.getElementById("whenDiffFromGit").innerText="　from GitHub",await ReviewCodes.getCodesFromGit()):await ReviewCodes.getCodes();let v="";if(ReviewCodes.codes[d])for(let r of ReviewCodes.codes[d]){let l=t(e(r.code.trim()));v+=`### ${r.file}\n${l}\n\n\n\n\n`}let b="";for(let r of CurriculumIdToData[d].files){const l=`${h}${r}`;let a;try{a=await fetch(l,{credentials:"include",cache:"no-cache",mode:"cors"})}catch(e){console.log(e)}const n=l.split("/").pop();let s;s=a?await a.text():"",C[(k=n,k.split(".").pop())]=s,s=t(e(s.trim())),b+=`### ${n}\n${s}\n\n\n\n\n`}var k;if((C.html||C.css)&&($("#VALIDATOR-LINK").on("click",(e=>{e.preventDefault(),C.html&&(e=>{const t=$("#HTML-VALIDATOR-FORM").get(0);t.content.value=e,t.submit()})(C.html),C.css&&(e=>{const t=$("#CSS-VALIDATOR-FORM").get(0);t.text.value=e,t.submit()})(C.css)})),$("#VALIDATOR-LINK").show()),document.title=`${p}さんの課題レビュー`,!ReviewCodes.codes[d])return $("#mergely").html(`<h3>${p}さんの課題</h3><p><strong>「${CurriculumIdToData[d].title}」</strong></p>\n      <p><code><a href="https://drive.google.com/drive/folders/${m}?usp=drive_link" target="_blank">/${m}</a>/${g}</code></p>\n      <p>この課題はコードの比較は出来ません。<br>直接プレビューしましょう。</p>\n      <ul>\n      <li><a href="${u}${CurriculumIdToData[d]?.files[0]}" target="_blank">プレビューを開く</a></li>\n      <li><a href="javascript:$('#VALIDATOR-LINK').click()">バリデータを開く</a></li>\n      `+("kadai-final-exam"==d?'<li><a href="#" id="FINAL-EXAM-CHECK-LINK">最終課題チェッカー</a></li>':"")+("kadai-css"==d?`<li><a href="${u}style.css" target="_blank">style.cssを開く</a></li>`:"")+(d.match(/jquery/)?`<li><a href="${u}main.js" target="_blank">main.jsを開く</a></li>`:"")+(CurriculumIdToData[d].demo?`<li><a href="${CurriculumIdToData[d].demo}" target="_blank">デモページ</a></li>`:"")+(CurriculumIdToData[d].description?`<li>${CurriculumIdToData[d].description}</li>`:"")+"</ul>"),void("kadai-final-exam"==d&&$("#FINAL-EXAM-CHECK-LINK").on("click",(e=>{e.preventDefault(),((e,t,r)=>{const l=$("#FINAL-EXAM-CHECKER").get(0);l.html.value=e,l.css.value=t,l.js.value=r,l.submit()})(C?.html,C?.css,C?.js)})));$("#NOW-LOADING").remove(),$("#page-content-wrapper > .container-fluid > .row > .col-lg-12 .header").css("visibility","visible"),$("#mergely").mergely({ignorews:!0,sidebar:!1,line_numbers:!1,loaded:()=>{l(b,v),setTimeout((()=>{o()}),500)}}),$("#mergeCurrentChange").on("click",(()=>{$("#mergely").mergely("mergeCurrentChange","lhs"),console.log("mergeCurrentChange")})),setTimeout((()=>{$("#mergely-splash").click()}),2e3),$("#mergely").on("updated",(()=>{const e=$("#mergely").mergely("summary");$(".header .controller .numChanges").text(e.numChanges?e.numChanges+" diffs":"No diffs"),o()})),$(".header .controller .prev,.header .controller .next").on("click",(e=>(e.preventDefault(),e.target.classList.contains("next")?$("#mergely").mergely("scrollToDiff","next"):$("#mergely").mergely("scrollToDiff","prev"),!1))),$("#remove-comments").on("click",(()=>{let{s_code:t,c_code:a}=r();t=e(t),a=e(a),l(t,a)})),$("#strip-emptyline").on("click",(()=>{let{s_code:e,c_code:a}=r();e=t(e),a=t(a),l(e,a)})),$("#css-sort").on("click",(async()=>{let{s_code:e,c_code:t}=r();l(await CSSSorter(e),await CSSSorter(t))})),$('input[type="checkbox"]').on("change",(e=>{const t={};t[e.target.id]=e.target.checked,$("#mergely").mergely("options",t)}))})();