(()=>{"use strict";(async()=>{let e;const t=await chrome.storage.local.get({new_version:!1,watchSlack:!1,chime:!1});let i;t.watchSlack&&chrome.runtime.onConnect.addListener((t=>{"SlackToBg"===t.name&&(e=t)})),chrome.runtime.onMessage.addListener(((i,n,c)=>{if(c(),"notification"===i.type&&chrome.notifications.create({title:i.title,message:i.body,type:"basic",iconUrl:"img/icon-128.png",silent:!0}),t.watchSlack&&"slack"===i.type){console.debug((new Date).toLocaleString()+" Receive the message from Slack."),console.debug(i);const n=i.data;let[c,o]=n.text.split("\n\n");o=o.replace("URL: <","").replace(">\n","");const s=i.title;if(e&&e.postMessage({type:"addReview",desc:c,url:o,title:s}),c.match(/課題.*レビュー中/))return;chrome.notifications.create({title:"課題の到着："+i.title,message:c,type:"basic",silent:!t.chime,iconUrl:"img/light_bulb.png",buttons:[{title:"課題レビュー開始"},{title:"閉じる"}]},(e=>{chrome.notifications.onButtonClicked.addListener(((t,i)=>{t===e&&0===i&&chrome.tabs.create({active:!0,url:o+"?open=1"})}))}))}}));const n=e=>{const t=e.split(".");return 65536*Number(t[0])+256*Number(t[1])+Number(t[2])},c=await fetch("https://raw.githubusercontent.com/ShigeUe/MentorCheckEx/main/mentor_check_ex/manifest.json"),o=await c.json();i=n(chrome.runtime.getManifest().version);const s=i<n(o.version);s&&!t.new_version&&chrome.notifications.create({title:"バージョンアップ",message:"MentorCheckExの新しいバージョンがあります。",type:"basic",iconUrl:"img/icon-128.png",silent:!0,buttons:[{title:"GitHubを開く"},{title:"閉じる"}]},(e=>{chrome.notifications.onButtonClicked.addListener(((t,i)=>{t===e&&0===i&&chrome.tabs.create({active:!0,url:"https://github.com/ShigeUe/MentorCheckEx"})}))})),chrome.storage.local.set({new_version:s})})()})();